(function(e){var a={init:function(i,o){a.self=this;a.arResultInfo=i;a.arParamsInfo=o;e("body").append(e(".bam-multiregions-confirm"));e("body").append(e(".bam-multiregions-popup"));e("body").append(e(".bam-multiregions-popupbg"));a.divMain=e(this);a.divConfirm=e(".bam-multiregions-confirm");a.divPopup=e(".bam-multiregions-popup");a.divPopupBg=e(".bam-multiregions-popupbg");if(a.arParamsInfo["CHANGE_CITY_MANUAL"]!="Y"){return}if(a.arParamsInfo["CITY_VERIFYCATION"]=="Y"&&a.arResultInfo["CONFIRM_REQUEST_SHOW"]){a._showConfirmCityWindow();e(a.divConfirm).on("click",".bam-multiregions-confirm-button-yes",function(){a._clickConfirmButtonYes(this);return false});e(a.divConfirm).on("click",".bam-multiregions-confirm-button-no",function(){a._clickConfirmButtonNo(this);return false})}e(a.divMain).on("click",".bam-multiregions-link",function(){a._clickShowPopupForm(this);return false});e(a.divPopup).on("change",".bam-multiregions-popup-content-search",function(){a._changeSearchCity(this);return false});e(a.divPopup).on("keyup",".bam-multiregions-popup-content-search",function(){a._changeSearchCity(this);return false});e(a.divPopup).on("click",".bam-multiregions-popup-content-item-link",function(){a._selectCityFromPopup(this);return false});e(a.divPopup).on("click",".bam-multiregions-popup-close",function(){a._clickHidePopupForm(this);return false});e(window).resize(function(){a._doResizeContent()});return this},destroy:function(){return this},_showConfirmCityWindow:function(){a.divConfirm.css("visibility","hidden");a.divConfirm.show();var i=a.divConfirm.outerWidth();a.divConfirm.hide();a.divConfirm.css("visibility","visible");var o=e(a.self).find(".bam-multiregions-link").offset();a.divConfirm.css("top",o.top+e(a.self).find(".bam-multiregions-link").outerHeight());a.divConfirm.css("left",o.left+(e(a.self).find(".bam-multiregions-link").outerWidth()-i)/2);a.divConfirm.fadeIn()},_clickConfirmButtonYes:function(i){var o={};o["PREVENT_CITY"]=a.arParamsInfo["PREVENT_CITY"];o["sid"]=a.arParamsInfo["SITE_ID"];o["AJAX"]="Y";o["action"]="setPreventCity";e.ajax(a.urlAjax,{cache:false,context:e(i),data:o,dataType:"json",method:"POST",type:"POST",success:function(i){if(i.STATUS=="SUCCESS"){a.divConfirm.fadeOut(400,function(){a.divConfirm.remove();a.divConfirm=null});if(i.LOCATION!=undefined&&i.LOCATION.length>0){window.location=i.LOCATION}}}})},_clickConfirmButtonNo:function(i){a.divConfirm.hide(1,function(){a.divConfirm.remove();a.divConfirm=null});a._clickShowPopupForm(i)},_clickShowPopupForm:function(i){if(a.divConfirm){a.divConfirm.hide(1,function(){a.divConfirm.remove();a.divConfirm=null})}a.doShowPopupForm()},_clickHidePopupForm:function(i){a.divPopup.hide();a.divPopupBg.hide()},doShowPopupForm:function(){if(this.arParamsInfo["USE_GPS"]=="Y"&&navigator.geolocation&&a.gpsPosition==false){a.gpsWait=true;a.divPopupBg.fadeIn(400);navigator.geolocation.getCurrentPosition(a.navigatorPosition,a.navigatorError);var i=setInterval(function(){if(!a.gpsWait){clearInterval(i);a._doShowPopupForm()}},20)}else{a._doShowPopupForm()}},_doShowPopupForm:function(){a.divPopup.html("");a.divPopup.append(e(a.popupTemplate));var i=a.arParamsInfo;i["GPS"]=a.gpsPosition;i["AJAX"]="Y";i["action"]="getCityForm";e.ajax(a.urlAjax,{cache:false,context:a.divPopup,data:i,dataType:"json",method:"POST",type:"POST",success:function(i){if(i.RESULT["IS_OK"]){a.divPopup.find(".bam-multiregions-popup-title h3").html(i.RESULT["TITLE"]);a.divPopup.find(".bam-multiregions-popup-content-search").attr("placeholder",i.RESULT["INPUT_PLACEHOLDER"]);a._doShowListCity(i.RESULT["ITEMS"])}}});a.divPopupBg.fadeIn(400);a.divPopup.fadeIn(400,function(){a._doResizeContent()})},_changeSearchCity:function(i){var o=a.arParamsInfo;o["GPS"]=a.gpsPosition;o["AJAX"]="Y";o["action"]="getCityForm";o["qcity"]=e(i).val();e.ajax(a.urlAjax,{cache:true,context:a.divPopup,data:o,dataType:"json",method:"POST",type:"POST",success:function(i){if(i.RESULT["IS_OK"]){a._doShowListCity(i.RESULT["ITEMS"])}}})},navigatorPosition:function(i){a.gpsPosition=i;a.gpsWait=false},navigatorError:function(){a.gpsPosition=false;a.gpsWait=false},_doShowListCity:function(i){var n=a.divPopup.find(".bam-multiregions-popup-content-list");var t="";n.html("");e.each(i,function(i,o){if(o["IS_CURRENT"]=="Y"){t=a.popupListContentItemCurrentTemplate}else{t=a.popupListContentItemTemplate}if(o.DOMAIN_NAME!=undefined){t=t.replace("#CITY_NAME#",o.DOMAIN_NAME);t=t.replace("#CITY_ID#",o.CITY_ID);t=t.replace("#CITY_TITLE#",o.FULL_NAME)}else{t=t.replace("#CITY_NAME#",o.CITY_NAME+" <span>("+o.FULL_NAME_NO_CITY+")</span>");t=t.replace("#CITY_ID#",o.CITY_ID);t=t.replace("#CITY_TITLE#",o.FULL_NAME_NO_CITY)}n.append(e(t))})},_selectCityFromPopup:function(o){var i={};i["PREVENT_CITY"]=e(o).data("id");i["sid"]=a.arParamsInfo["SITE_ID"];i["AJAX"]="Y";i["action"]="setPreventCity";e.ajax(a.urlAjax,{cache:false,context:e(o),data:i,dataType:"json",method:"POST",type:"POST",success:function(i){if(i.STATUS=="SUCCESS"){a._clickHidePopupForm(o);if(i.LOCATION!=undefined&&i.LOCATION.length>0){window.location=i.LOCATION}else{window.location.reload()}}}})},_doResizeContent:function(){if(a.divPopup.find(".bam-multiregions-popup-content-list").length>0){a.divPopup.find(".bam-multiregions-popup-content-list").height(a.divPopup.find(".bam-multiregions-popup-window").height()-100)}},arResultInfo:{},arParamsInfo:{},self:null,divConfirm:null,divPopup:null,divPopupBg:null,urlAjax:"/bitrix/components/kit/multiregions.selector/ajax.php",popupTemplate:'<div class="bam-multiregions-popup-window"><div class="bam-multiregions-popup-title"><h3></h3><a href="javascript:void(0)" class="bam-multiregions-popup-close"></a></div><div class="bam-multiregions-popup-content"><input type="text" value="" class="bam-multiregions-popup-content-search" placeholder=""/><div class="bam-multiregions-popup-content-list"></div></div></div>',popupListContentItemTemplate:'<div class="bam-multiregions-popup-content-item"><a href="javascript:void(0)" class="bam-multiregions-popup-content-item-link" data-id="#CITY_ID#" title="#CITY_TITLE#">#CITY_NAME#</a></div>',popupListContentItemCurrentTemplate:'<div class="bam-multiregions-popup-content-item"><a href="javascript:void(0)" class="bam-multiregions-popup-content-item-link bam-multiregions-popup-content-item-link-current" data-id="#CITY_ID#" title="#CITY_TITLE#">#CITY_NAME#</a></div>',gpsWait:false,gpsPosition:false};e.fn.kitMultiRegions=function(i){if(a[i]){return a[i].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof i==="object"||!i){return a.init.apply(this,arguments)}else{e.error("Not exists method "+i)}}})(jQuery);